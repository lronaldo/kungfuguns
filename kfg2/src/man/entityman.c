#include "entityman.h"
#include <cpctelera.h>

///----------------------------------------------------------------------------
///----------------------------------------------------------------------------
/// DATA
///----------------------------------------------------------------------------
///----------------------------------------------------------------------------
Entity_t entities_[EM_MaxEntities]; // Entity Space
Entity_t const * const entities_end = entities_ + EM_MaxEntities;
Entity_t const entity_template_ = {
   .cmps = EM_DEFAULT_CMPS
};

///----------------------------------------------------------------------------
///----------------------------------------------------------------------------
/// FUNCTIONS
///----------------------------------------------------------------------------
///----------------------------------------------------------------------------
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void man_entity_init() {
   cpct_memset(entities_, 0, sizeof(entities_));
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
Entity_t* 
man_entity_first_free() {
   Entity_t* e = entities_;
   while(e->cmps != EM_FREE_ENTITY) 
      ++e;
   return e;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
Entity_t*
man_entity_create() {
   Entity_t* e = man_entity_first_free();
   cpct_memcpy(e, &entity_template_, sizeof(Entity_t));
   return e;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void
man_entity_forall(EntityFuncPtr const Process) __z88dk_fastcall {
   Entity_t* e = entities_;
   while(e < entities_end) {
      if (e->cmps != EM_FREE_ENTITY)
         Process(e);
      ++e;
   }
}