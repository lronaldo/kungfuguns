#include "entityman.h"
#include <utils.h>
#include <cpctelera.h>

///----------------------------------------------------------------------------
///----------------------------------------------------------------------------
/// DATA
///----------------------------------------------------------------------------
///----------------------------------------------------------------------------
Entity_t entities_[EM_MaxEntities]; // Entity Space
Entity_t const * const entities_end = entities_ + EM_MaxEntities;

///----------------------------------------------------------------------------
///----------------------------------------------------------------------------
/// FUNCTIONS
///----------------------------------------------------------------------------
///----------------------------------------------------------------------------

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
Entity_t* 
man_entity_getByID(u8 const id) __z88dk_fastcall {
   return entities_ + id;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void man_entity_init(void) {
   cpct_memset(entities_, 0, sizeof(entities_));
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
Entity_t* 
man_entity_first_free(void) {
   Entity_t* e = entities_;
   while( IS_VALID_ENTITY(e) )
      ++e;
   return e;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
Entity_t*
man_entity_create(Entity_t const * const e_template) __z88dk_fastcall {
   Entity_t* e = man_entity_first_free();
   cpct_memcpy(e, e_template, sizeof(Entity_t));
   return e;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void
man_entity_forall(EntityFunPtr const Process) __z88dk_fastcall {
   Entity_t* e = entities_;
   while(e < entities_end) {
      if ( IS_VALID_ENTITY(e) )
         Process(e);
      ++e;
   }
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void
man_entity_foreach(EntityFunPtr const Process, u8 const cmps) {
   Entity_t* e = entities_;
   while(e < entities_end) {
      if ( HAS_COMPONENTS_PTR(e, cmps) )
         Process(e);
      ++e;
   }
}