#include "entityman.h"
#include <utils.h>
#include <cpctelera.h>

///----------------------------------------------------------------------------
///----------------------------------------------------------------------------
/// DATA
///----------------------------------------------------------------------------
///----------------------------------------------------------------------------
Entity_t entities_[EM_MaxEntities]; // Entity Space
Entity_t const * const entities_end = entities_ + EM_MaxEntities;
Entity_t const entity_template_ = {
   .cmps = EM_DEFAULT_CMPS,
   .x = 0, .y = 0,
   .vx = 0, .vy = 0,
   .w = 1, .h = 1,
   .sprite = nullptr
};

///----------------------------------------------------------------------------
///----------------------------------------------------------------------------
/// FUNCTIONS
///----------------------------------------------------------------------------
///----------------------------------------------------------------------------

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
Entity_t* 
man_entity_getByID(u8 const id) __z88dk_fastcall {
   return entities_ + id;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void man_entity_init(void) {
   cpct_memset(entities_, 0, sizeof(entities_));
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
Entity_t* 
man_entity_first_free(void) {
   Entity_t* e = entities_;
   while( IS_VALID_ENTITY(e) )
      ++e;
   return e;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
Entity_t*
man_entity_create(void) {
   Entity_t* e = man_entity_first_free();
   cpct_memcpy(e, &entity_template_, sizeof(Entity_t));
   return e;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void
man_entity_forall(EntityFuncPtr const Process) __z88dk_fastcall {
   Entity_t* e = entities_;
   while(e < entities_end) {
      if ( IS_VALID_ENTITY(e) )
         Process(e);
      ++e;
   }
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void
man_entity_foreach(EntityFuncPtr const Process, u8 const cmps) {
   Entity_t* e = entities_;
   while(e < entities_end) {
      if ( HAS_COMPONENTS_PTR(e, cmps) )
         Process(e);
      ++e;
   }
}